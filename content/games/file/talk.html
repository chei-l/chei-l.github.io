<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë¹„ë°€ ëŒ€í™”ë°©</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nanum+Gothic:wght@400;700&display=swap');
        
        body {
            font-family: 'Nanum Gothic', sans-serif;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
        }
        
        #main-container {
            width: 100%;
            max-width: 600px; 
            height: 90vh;
            max-height: 850px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            border-radius: 20px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
            background-color: #abc1d1;
        }

        .chat-bubble-left {
            position: relative;
            background: #ffffff;
            border-radius: 12px;
            padding: 10px 16px;
            margin-bottom: 4px;
            max-width: 80%;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            font-size: 1rem;
            margin-left: 12px;
        }
        
        .chat-bubble-left::after {
            content: '';
            position: absolute;
            left: -8px;
            top: 12px;
            border-top: 6px solid transparent;
            border-bottom: 6px solid transparent;
            border-right: 8px solid #ffffff;
        }

        .chat-bubble-right {
            position: relative;
            background: #fef01b;
            border-radius: 12px;
            padding: 10px 16px;
            margin-bottom: 4px;
            max-width: 80%;
            margin-left: auto;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            font-size: 1rem;
            margin-right: 12px;
        }

        .chat-bubble-right::after {
            content: '';
            position: absolute;
            right: -8px;
            top: 12px;
            border-top: 6px solid transparent;
            border-bottom: 6px solid transparent;
            border-left: 8px solid #fef01b;
        }

        .profile-img {
            width: 50px;
            height: 50px;
            border-radius: 18px;
            background-color: #ffffff;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #ddd;
            overflow: hidden;
            flex-shrink: 0;
        }

        .profile-img img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .chat-time {
            color: #555;
            font-size: 0.7rem;
            align-self: flex-end;
            margin-bottom: 6px;
            margin-left: 6px;
            margin-right: 6px;
        }

        .system-msg {
            text-align: center;
            font-size: 0.8rem;
            color: #ffffff;
            background: rgba(0,0,0,0.2);
            border-radius: 25px;
            padding: 5px 20px;
            display: inline-block;
        }

        #draw-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            z-index: 100;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        #canvas-container {
            background: white;
            border-radius: 24px;
            width: 100%;
            max-width: 450px;
            padding: 25px;
            text-align: center;
        }
        canvas {
            border: 3px solid #f3f4f6;
            border-radius: 15px;
            background: white;
            touch-action: none;
            margin: 0 auto;
            display: block;
        }

        .draw-btn {
            font-size: 0.8rem;
            padding: 4px 10px;
            background: #f3f4f6;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            color: #4b5563;
        }

        /* ë‚˜ê°€ê¸° ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .exit-btn {
            background-color: rgba(255, 255, 255, 0.3);
            padding: 4px 12px;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: bold;
            color: #333;
            border: 1px solid rgba(0,0,0,0.05);
            transition: all 0.2s;
        }
        .exit-btn:hover { background-color: rgba(255, 255, 255, 0.5); }

        .typing-dots {
            display: flex;
            gap: 6px;
            padding: 12px;
            background: rgba(255,255,255,0.5);
            border-radius: 12px;
            margin-left: 12px;
        }
        .dot {
            width: 8px;
            height: 8px;
            background: #888;
            border-radius: 50%;
            animation: bounce 1s infinite;
        }
        .dot:nth-child(2) { animation-delay: 0.2s; }
        .dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-6px); }
        }
    </style>
</head>
<body>

    <div id="main-container">
        
        <div id="chat-header" class="p-5 flex justify-between items-center bg-[#abc1d1] border-b border-black/5">
            <div class="flex items-center gap-3">
                <button onclick="exitRoom()" class="exit-btn">ë‚˜ê°€ê¸°</button>
                <h1 id="room-title" class="text-xl font-bold text-gray-800">ì±„íŒ…ë°©</h1>
            </div>
            <div class="flex gap-5 text-xl">
                <span>ğŸ”</span>
                <span class="cursor-pointer">â‰¡</span>
            </div>
        </div>

        <!-- ì„¤ì • í™”ë©´ (ë¡œê·¸ì¸) -->
        <div id="login-screen" class="absolute inset-0 z-20 bg-white p-10 flex flex-col justify-center items-center overflow-y-auto">
            <div class="mb-8 text-center">
                <h2 class="text-3xl font-extrabold text-gray-800">ìºë¦­í„° ë§Œë“¤ê¸° ğŸ¨</h2>
                <p class="text-gray-500 mt-2 font-medium">ì²´ì´ê°€ ì›í•˜ëŠ” ëª¨ìŠµìœ¼ë¡œ ê·¸ë ¤ì¤˜!</p>
            </div>
            
            <div class="w-full max-w-md space-y-6">
                <div class="bg-gray-50 p-4 rounded-2xl border border-gray-200 flex flex-col items-center shadow-sm">
                    <div class="w-full flex justify-between items-center mb-3">
                        <label class="text-xs font-bold text-pink-500 bg-pink-50 px-2 py-1 rounded-md">ë‚´ ìºë¦­í„°</label>
                        <button onclick="openDraw(1)" class="draw-btn">âœï¸ ê·¸ë¦¬ê¸°</button>
                    </div>
                    <div class="flex items-center gap-4 w-full">
                        <div id="p1-preview" class="profile-img bg-white shadow-inner">
                            <svg viewBox="0 0 100 100" width="100%" height="100%"><rect width="100" height="100" fill="#f3f4f6"/><text x="50" y="60" font-size="40" text-anchor="middle">ğŸ¦Š</text></svg>
                        </div>
                        <input type="text" id="p1-name" placeholder="ì´ë¦„" value="ì²´ì´" class="flex-1 border-b-2 border-gray-300 p-2 text-lg outline-none bg-transparent font-bold">
                    </div>
                </div>

                <div class="bg-gray-50 p-4 rounded-2xl border border-gray-200 flex flex-col items-center shadow-sm">
                    <div class="w-full flex justify-between items-center mb-3">
                        <label class="text-xs font-bold text-blue-500 bg-blue-50 px-2 py-1 rounded-md">ì¹œêµ¬ ìºë¦­í„°</label>
                        <button onclick="openDraw(2)" class="draw-btn">âœï¸ ê·¸ë¦¬ê¸°</button>
                    </div>
                    <div class="flex items-center gap-4 w-full">
                        <div id="p2-preview" class="profile-img bg-white shadow-inner">
                            <svg viewBox="0 0 100 100" width="100%" height="100%"><rect width="100" height="100" fill="#f3f4f6"/><text x="50" y="60" font-size="40" text-anchor="middle">ğŸ‘¤</text></svg>
                        </div>
                        <input type="text" id="p2-name" placeholder="ì¹œêµ¬ ì´ë¦„" value="ë‹¤ì •ì¹œêµ¬" class="flex-1 border-b-2 border-gray-300 p-2 text-lg outline-none bg-transparent font-bold">
                    </div>
                </div>
            </div>
            
            <button onclick="enterRoom()" class="w-full max-w-md bg-[#fee500] text-gray-800 font-black text-xl py-4 mt-10 rounded-2xl shadow-lg active:scale-95 transition-all">
                ëŒ€í™” ì‹œì‘!
            </button>
        </div>

        <!-- ì±„íŒ…ì°½ -->
        <div id="chat-box" class="flex-1 overflow-y-auto p-5 flex flex-col gap-2"></div>

        <!-- ì…ë ¥ì°½ -->
        <div id="input-area" class="hidden bg-white p-4 flex flex-col border-t">
            <div class="flex items-end gap-3 w-full">
                <div class="bg-gray-100 rounded-2xl flex-1 flex p-3 items-center border border-gray-200">
                    <textarea id="chat-input" rows="1" placeholder="ë©”ì‹œì§€ ë³´ë‚´ê¸°..." class="bg-transparent flex-1 outline-none text-base resize-none overflow-hidden max-h-32"></textarea>
                </div>
                <button onclick="sendMsg()" id="send-btn" class="bg-[#fee500] w-16 h-12 rounded-xl font-bold text-base opacity-50 shadow-sm" disabled>ì „ì†¡</button>
            </div>
        </div>
    </div>

    <!-- ê·¸ë¦¼ ê·¸ë¦¬ê¸° ëª¨ë‹¬ -->
    <div id="draw-modal">
        <div id="canvas-container" class="shadow-2xl">
            <h3 class="text-xl font-black mb-4">ì˜ˆì˜ê²Œ ê·¸ë ¤ì¤˜! ğŸ¨</h3>
            <canvas id="paint-canvas" width="300" height="300"></canvas>
            <div class="flex justify-between mt-6 gap-3">
                <button onclick="closeDraw(false)" class="bg-gray-100 text-gray-600 flex-1 py-3 rounded-xl font-bold">ì·¨ì†Œ</button>
                <button onclick="clearCanvas()" class="bg-red-50 text-red-500 flex-1 py-3 rounded-xl font-bold">ì§€ìš°ê¸°</button>
                <button onclick="closeDraw(true)" class="bg-yellow-400 text-gray-800 flex-1 py-3 rounded-xl font-black">ì™„ë£Œ</button>
            </div>
        </div>
    </div>

    <script>
        const apiKey = "";
        let p1 = { name: "ì²´ì´", icon: null, defaultHtml: `<svg viewBox="0 0 100 100" width="100%" height="100%"><rect width="100" height="100" fill="#fff"/><text x="50" y="65" font-size="50" text-anchor="middle">ğŸ¦Š</text></svg>` };
        let p2 = { name: "ì¹œêµ¬", icon: null, defaultHtml: `<svg viewBox="0 0 100 100" width="100%" height="100%"><rect width="100" height="100" fill="#fff"/><text x="50" y="65" font-size="50" text-anchor="middle">ğŸ‘¤</text></svg>` };
        let drawingFor = 0;

        const chatBox = document.getElementById('chat-box');
        const loginScreen = document.getElementById('login-screen');
        const inputArea = document.getElementById('input-area');
        const chatInput = document.getElementById('chat-input');
        const sendBtn = document.getElementById('send-btn');
        const canvas = document.getElementById('paint-canvas');
        const ctx = canvas.getContext('2d');
        let isDrawing = false;

        // ì˜¤ë””ì˜¤ ì»¨í…ìŠ¤íŠ¸ ì„¤ì •
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        // ì¹´í†¡ ì•Œë¦¼ìŒ ì¬ìƒ í•¨ìˆ˜
        function playKatalkSound() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            
            const now = audioCtx.currentTime;
            
            // "ì¹´" ì†Œë¦¬ (ë†’ì€ í†¤)
            const osc1 = audioCtx.createOscillator();
            const gain1 = audioCtx.createGain();
            osc1.connect(gain1); gain1.connect(audioCtx.destination);
            osc1.type = 'sine';
            osc1.frequency.setValueAtTime(1200, now);
            gain1.gain.setValueAtTime(0.1, now);
            gain1.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
            osc1.start(); osc1.stop(now + 0.1);

            // "í†¡" ì†Œë¦¬ (ì¡°ê¸ˆ ë” ë†’ì€ í†¤)
            const osc2 = audioCtx.createOscillator();
            const gain2 = audioCtx.createGain();
            osc2.connect(gain2); gain2.connect(audioCtx.destination);
            osc2.type = 'sine';
            osc2.frequency.setValueAtTime(1500, now + 0.1);
            gain2.gain.setValueAtTime(0.1, now + 0.1);
            gain2.gain.exponentialRampToValueAtTime(0.01, now + 0.25);
            osc2.start(now + 0.1); osc2.stop(now + 0.25);
        }

        function openDraw(num) {
            drawingFor = num;
            document.getElementById('draw-modal').style.display = 'flex';
            clearCanvas();
        }

        function clearCanvas() {
            ctx.fillStyle = "white";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.lineWidth = 5;
            ctx.lineCap = "round";
            ctx.strokeStyle = "black";
        }

        function closeDraw(save) {
            if (save) {
                const dataUrl = canvas.toDataURL();
                if (drawingFor === 1) {
                    p1.icon = dataUrl;
                    document.getElementById('p1-preview').innerHTML = `<img src="${dataUrl}">`;
                } else {
                    p2.icon = dataUrl;
                    document.getElementById('p2-preview').innerHTML = `<img src="${dataUrl}">`;
                }
            }
            document.getElementById('draw-modal').style.display = 'none';
        }

        function getPos(e) {
            const rect = canvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            return { x: clientX - rect.left, y: clientY - rect.top };
        }

        canvas.onmousedown = (e) => { isDrawing = true; ctx.beginPath(); const p = getPos(e); ctx.moveTo(p.x, p.y); };
        canvas.onmousemove = (e) => { if(!isDrawing) return; const p = getPos(e); ctx.lineTo(p.x, p.y); ctx.stroke(); e.preventDefault(); };
        window.onmouseup = () => isDrawing = false;
        canvas.ontouchstart = (e) => { isDrawing = true; ctx.beginPath(); const p = getPos(e); ctx.moveTo(p.x, p.y); e.preventDefault(); };
        canvas.ontouchmove = (e) => { if(!isDrawing) return; const p = getPos(e); ctx.lineTo(p.x, p.y); ctx.stroke(); e.preventDefault(); };

        chatInput.oninput = function() {
            sendBtn.disabled = this.value.trim().length === 0;
            sendBtn.style.opacity = sendBtn.disabled ? "0.5" : "1";
            this.style.height = 'auto';
            this.style.height = this.scrollHeight + 'px';
        };

        function enterRoom() {
            p1.name = document.getElementById('p1-name').value || "ì²´ì´";
            p2.name = document.getElementById('p2-name').value || "ì¹œêµ¬";
            loginScreen.style.display = 'none';
            inputArea.classList.remove('hidden');
            document.getElementById('room-title').innerText = p2.name;
            addSystemMsg(`${p2.name}ë‹˜ê³¼ ëŒ€í™”ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        }

        function exitRoom() {
            loginScreen.style.display = 'flex';
            inputArea.classList.add('hidden');
            chatBox.innerHTML = '';
            document.getElementById('room-title').innerText = 'ì±„íŒ…ë°©';
        }

        function addSystemMsg(text) {
            const div = document.createElement('div');
            div.className = "flex justify-center w-full my-3";
            div.innerHTML = `<div class="system-msg">${text}</div>`;
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function addChat(char, text, side) {
            const container = document.createElement('div');
            container.className = side === 'left' ? "flex mb-5 items-start" : "flex mb-5 justify-end items-end";
            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            let iconContent = char.icon ? `<img src="${char.icon}">` : char.defaultHtml;
            
            if (side === 'left') {
                container.innerHTML = `<div class="profile-img shadow-sm">${iconContent}</div><div class="flex flex-col"><div class="ml-4 text-xs font-bold text-gray-700 mb-1">${char.name}</div><div class="flex items-end"><div class="chat-bubble-left">${text}</div><span class="chat-time">${time}</span></div></div>`;
            } else {
                container.innerHTML = `<div class="flex items-end"><span class="chat-time">${time}</span><div class="chat-bubble-right">${text}</div></div>`;
            }
            chatBox.appendChild(container);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        async function sendMsg() {
            const text = chatInput.value.trim();
            if (!text) return;
            addChat(p1, text, 'right');
            chatInput.value = "";
            chatInput.style.height = 'auto';
            sendBtn.disabled = true;
            
            const loadingDiv = document.createElement('div');
            loadingDiv.className = "flex mb-5 items-start";
            loadingDiv.innerHTML = `<div class="profile-img shadow-sm">${p2.icon ? `<img src="${p2.icon}">` : p2.defaultHtml}</div><div class="flex flex-col"><div class="ml-4 text-xs font-bold text-gray-700 mb-1">${p2.name}</div><div class="typing-dots"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div></div>`;
            chatBox.appendChild(loadingDiv);
            chatBox.scrollTop = chatBox.scrollHeight;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: text }] }],
                        systemInstruction: { parts: [{ text: `ë„ˆëŠ” ì´ˆë“±í•™ìƒ '${p1.name}'ì˜ ë‹¨ì§ ì¹œêµ¬ '${p2.name}'ì´ì•¼. ì•„ì£¼ ë‹¤ì •í•˜ê³  ë°ê³  ì¬ë¯¸ìˆê²Œ ë°˜ë§ë¡œ ëŒ€ë‹µí•´ì¤˜. ì§§ì€ ë¬¸ì¥ ìœ„ì£¼ë¡œ ì¹´í†¡ í•˜ë“¯ì´ ë§í•˜ê³ , ì´ëª¨í‹°ì½˜ë„ ì„ì–´ì„œ ì¨ì¤˜.` }] }
                    })
                });
                const result = await response.json();
                const reply = result.candidates?.[0]?.content?.parts?.[0]?.text || "ì–´ë¼? ë‹¤ì‹œ ë§í•´ì¤„ë˜?";
                
                chatBox.removeChild(loadingDiv);
                addChat(p2, reply, 'left');
                playKatalkSound(); // ë‹µì¥ì´ ì˜¬ ë•Œ ì†Œë¦¬ ì¬ìƒ

            } catch (error) {
                chatBox.removeChild(loadingDiv);
                addChat(p2, "ë‚˜ ì§€ê¸ˆ ì ê¹ ì¸í„°ë„·ì´ ì•ˆ ë˜ë‚˜ ë´! ë‹¤ì‹œ ë³´ë‚´ì¤˜!", 'left');
            }
        }
    </script>
</body>
</html>